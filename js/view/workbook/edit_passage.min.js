function pageinit(e,t,c){$(window).on("unload",()=>$("#loadingModal").modal("hide"));let g=Number(sessionStorage.getItem("editingPassageId")||sessionStorage.getItem("passageId")),n,i=(document.referrer?n=new URL(document.referrer).pathname?.match(/(\/mybook\/edit\/|\/workbook\/study\/overview\/|\/workbook\/passage\/)(\w+)/)?.[2]:sessionStorage.getItem("workbookId")&&(n=ntoa(sessionStorage.getItem("workbookId"))),".list-sentence-section"),u=".one-sentence-unit-section",m=500,d={el:"div",class:"one-sentence-unit-section p-2 p-lg-4 mb-2 border-0","data-ordernum":"0","data-sid":"0",children:[{el:"div",class:"origin-sentence-section my-auto",children:[{el:"div",class:"d-none d-md-block edit-btn-section",children:[{el:"span",role:"button",class:"js-move-sentence btn edit-btn ui-sortable-handle","data-toggle":"tooltip",title:"위치 이동",children:[{el:"span",class:"fas fa-arrows-alt"}]},{el:"button",type:"button",class:"js-del-sentence btn edit-btn","data-toggle":"tooltip",title:"문장 삭제",children:[{el:"span",class:"fas fa-trash-alt"}]},{el:"button",type:"button",class:"edit-icon-section btn edit-btn","data-toggle":"collapse",children:[{el:"span",class:"edit-icon fas fa-pen"}]}]},{el:"div",class:"d-block d-md-none float-end border rounded-3 px-1",children:[{el:"span",role:"button",class:"js-move-sentence d-block btn p-1 ui-sortable-handle","data-toggle":"tooltip",title:"위치 이동",children:[{el:"span",class:"fas fa-arrows-alt"}]},{el:"button",type:"button",class:"js-del-sentence d-block btn p-1 mx-auto","data-toggle":"tooltip",title:"문장 삭제",children:[{el:"span",class:"fas fa-trash-alt"}]},{el:"button",type:"button",class:"edit-icon-section d-block btn p-1","data-toggle":"collapse",children:[{el:"span",class:"edit-icon fas fa-pen"}]}]},{el:"div",class:"origin-sentence",role:"button","data-toggle":"collapse",children:[{el:"span",class:"numbering-text",textContent:"3"},{el:"span",class:"sentence-text",textContent:""}]},{el:"div",class:"edit-section collapse mt-2",children:[{el:"textarea",class:"form-control mb-2",rows:"5",textContent:""},{el:"button",type:"button",class:"btn btn-outline-fico","data-toggle":"collapse",textContent:"취소"},{el:"button",type:"button",class:"js-edit btn btn-fico",disabled:!0,textContent:"수정"},{el:"span",class:"invalid-text text-danger",style:"display: none;",textContent:"영문이 아니거나 글자수가 너무 많습니다."}]}]}]},a=1e4.toLocaleString();var o=(new Date).format("yyyy-MM-dd");let s="MFUSG";var l=localStorage.getItem(s);let h=l?JSON.parse(atob(l)):{},r=[];l=[$.getJSON("https://static.findsvoc.com/data/member/unlockedLimitMembers.json?time="+Date.now().toString()).done(e=>r=e)];function f(e){!c&&!r.includes(t)&&1e4<=h.length?($(".js-open-add-sentence,.edit-icon-section").attr("data-toggle","tooltip").attr("title","일일 사용량을 초과하여 문장의 추가 및 수정이 불가합니다.").prop("disabled",!0),$(".origin-sentence").removeAttr("data-toggle"),d.children[0].children[0].children[2].disabled=!0,d.children[0].children[1].children[2].disabled=!0,delete d.children[0].children[2]["data-toggle"],alertModal(`일일 분석량<span class="text-red-700">(${a}자)</span>을 모두 <span class="text-red-700">소진</span>하여
문장의 <span class="text-red-700">추가 및 수정</span>이 불가합니다.
문장의 <span class="text-blue-600">순서 이동 및 삭제</span>는 가능합니다.`,()=>e&&e()),localStorage.setItem(s,btoa(JSON.stringify(h)))):(localStorage.setItem(s,btoa(JSON.stringify(h))),e&&e())}function b(e){anime({targets:e,duration:1e3,easing:"linear",direction:"alternate",backgroundColor:"#ffc107"})}function p(){var e;0==$(u).length?(e=sessionStorage.getItem("workbookType"),!["C","T"].includes(e)&&0!=(e=Number(sessionStorage.getItem("workbookId")||0))&&0!=g?deletePassage({workbookId:e,passageId:g},()=>{alertModal("지문이 완전히 비어 삭제됩니다.\n워크북 수정 화면에서 새 지문을 등록하세요.",()=>{location.replace("/workbook/mybook/edit/"+n)})}):alertModal("지문이 완전히 비었습니다.\n워크북 수정 화면으로 이동합니다.",()=>{location.replace("/workbook/mybook/edit/"+n)})):$(i).html($(u).sort((e,t)=>e.dataset.ordernum-t.dataset.ordernum).each((e,t)=>$(t).find(".numbering-text").text(e+1)))}function x(){var e=!c&&1500<=Array.from($(u+" .sentence-text").get(),e=>e.textContent).join("").length;$(".exceed-max-notice")[e?"slideDown":"slideUp"](100),$(".js-open-add-sentence")[e?"slideUp":"slideDown"](100)}h.user===ntoa(t)&&h.date===o||(h={user:ntoa(t),date:o,length:0},l.push($.getJSON("/workbook/passage/usage").done(e=>Object.assign(h,{length:e})))),Promise.allSettled(l).then(()=>{f()}),e.sort((e,t)=>e.orderNum-t.orderNum).forEach((e,t)=>{var n=createElement(d);n.dataset.ordernum=e.orderNum,n.dataset.sid=e.sentenceId,n.querySelector(".numbering-text").textContent=t+1,n.querySelector(".sentence-text").textContent=e.eng,n.querySelector(".edit-section textarea").textContent=e.eng,document.querySelector(i).appendChild(n)}),x(),$("#addPassageBtn").click(()=>location.assign("/workbook/passage/add/"+n)),$("#viewPassageBtn").click(()=>location.assign(`/workbook/passage/${n}/`+ntoa(g))),$("#editWorkbookBtn").click(()=>location.assign("/workbook/mybook/edit/"+n)),$(i).sortable({containment:"parent",axis:"y",items:">"+u,handle:".js-move-sentence",classes:{"ui-sortable-helper":"shadow-lg"},cursor:"move",update:(e,t)=>{if(confirm("문장을 여기로 이동하겠습니까?")){var n=t.item.prev(u),a=t.item.next(u);if(0==a.length)t.item[0].dataset.ordernum=Number(n[0].dataset.ordernum)+1e3;else if(0==n.length){var o=Number(a[0].dataset.ordernum),s=Math.round(o/2);if(s==o)return alertModal("더이상 이동할 수 없습니다."),void $(i).sortable("cancel");t.item[0].dataset.ordernum=s}else{o=Number(n[0].dataset.ordernum),s=Number(a[0].dataset.ordernum),n=Math.round((o+s)/2);if(-1<[o,s].indexOf(n))return alertModal("더이상 이동할 수 없습니다."),void $(i).sortable("cancel");t.item[0].dataset.ordernum=n}a={sentenceId:Number(t.item.data("sid")),sameText:!0,passageId:g,eng:t.item.find(".sentence-text").text(),orderNum:Number(t.item[0].dataset.ordernum)};editPassageSentece(a,p)}else $(i).sortable("cancel")}}),$(".js-open-add-sentence").click(function(){$(this).add($(".add-section")).slideToggle(100,()=>$(".add-section textarea").focus())}),$(".js-cancel-add").click(function(){$(".add-section textarea").val("").trigger("input"),$(".add-section,.js-open-add-sentence").slideToggle(100)}),$(document).on("click",u+' [data-toggle="collapse"]',function(){$(this.closest(u)).find(".collapse").collapse("toggle")}),$(document).on("input",".edit-section textarea,.add-section textarea",function(){var e=this.closest(".edit-section, .add-section"),t=e.querySelector(".js-edit, .js-add"),n=e.querySelector(".invalid-text"),e=$(e).closest(".one-sentence-unit-section").find(".sentence-text"),{input:a,inputCursor:o}=extractHighlightInfo(this.value,this.selectionStart);let s=!1;0===a.length?s=!0:!c&&3e3<a.length+$(".one-sentence-unit-section .sentence-text").not(e).text().length?(n.textContent="한 지문에 들어가는 글자수가 너무 많습니다.",s=!0):(e=tokenizer.sentences(a.sentenceNormalize()),!c&&e.some(e=>e.length>m)?(e=e.findIndex(e=>e.length>m)+1,n.textContent=e+"번째 문장의 글자수가 너무 많습니다.",s=!0):a.includes("×")&&(n.textContent="영문장에 부적절한 문자가 포함되어 × 기호로 치환됐습니다.",s=!0)),n.style.display=s?"block":"none",t.disabled=s,a.includes("×")&&(this.value=a,$(this).highlightWithinTextarea({highlight:[{className:"bg-fc-yellow",highlight:["×"]}]}),this.setSelectionRange(o,o),this.focus())}),$(".js-add").on("click",function(){let a=$(".add-section textarea").val().sentenceNormalize();var e=tokenizer.sentences(a),t=Number($(u+":last")[0]?.dataset?.ordernum||0)+1e3,s=wrapQuotes(e.filter(e=>/[a-zA-Z\s]/.test(e)));if(0!==s.length){e=s.join(" ").capitalize1st();let n=!1;if($(u+" .sentence-text").each((e,t)=>{if(-1<a.indexOf(t.textContent))return alertModal(e+1+"번째 문장 내용과 중복됩니다."),!(n=!0)}),!n){let a=$(".add-section textarea").get(0),o=(a.value=e,0);for(let n=0,e=s.length;n<e;n++){let t=s[n];var l=e=>{alertModal(n+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+t,()=>{a.focus(),a.setSelectionRange(o,o+t.length)})};if(!c&&t.length>m)return void l("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!REGEX_VALID_SENTENCE_START.test(t))return void l(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp(REGEX_STR_VALID_SENTENCE_END).test(t))return void l(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);o+=t.length+(n<e-1?1:0)}h.length+=e.length;e={sentenceId:0,passageId:g,eng:e,orderNum:t};$("#loadingModal").modal("show"),editPassageSentece(e,function(a){var e=$("#loadingModal");if(e.modal("hide"),0!==a.length){var o=document.querySelector(i);let t=[],n=`아래와 같은 ${a.length}개의 문장이 추가되었습니다.`;$(".js-cancel-add").trigger("click");for(let e=0;e<a.length;e++){var s=a[e],l=createElement(d);l.querySelector(".sentence-text").textContent=s.eng,l.querySelector(".edit-section textarea").textContent=s.eng,l.dataset.sid=s.sentenceId,l.dataset.ordernum=s.orderNum,o.appendChild(l),n+=`
[${e+1}] `+s.eng,t.push(l)}p(),x(),alertModal(n,()=>{f(()=>b(t))})}},function(){var e=$("#loadingModal");alertModal("등록에 실패했습니다."),e.modal("hide")})}}}),$(document).on("click",".js-edit",async function(){let i=$(this.closest(u));var e=i.find(".sentence-text").text();let s=i.find(".edit-section textarea").val().sentenceNormalize();if(s==e)alertModal("원문과 내용이 동일합니다.");else{let n=!1;if($(u+" .sentence-text").each((e,t)=>{if(-1<s.indexOf(t.textContent))return alertModal(e+1+"번째 문장 내용과 중복됩니다."),!(n=!0)}),!n){var t=tokenizer.sentences(s);if(1<t.length&&i.index()<$(u).length-1)if(!await new Promise((e,t)=>{confirmModal("현재 문장을 여러 개의 문장으로 수정할 경우 지문의 문장 순서가 변경될 수 있습니다.\n먼저<b>추가 문장 등록</b>을 완료한 후, <b>위치 이동</b>을 진행하는 것을 권장합니다.\n단일 문장이 확실하다면 '확인'을 눌러 계속하세요.",()=>e(!0),()=>e(!1))}))return;var l,d=wrapQuotes(t.filter(e=>/[a-zA-Z\s]/.test(e))),t=d.join(" ").capitalize1st();let a=i.find(".edit-section textarea").get(0),o=(a.value=t,0);for(let n=0,e=d.length;n<e;n++){let t=d[n];var r=e=>{alertModal(n+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+t,()=>{a.focus(),a.setSelectionRange(o,o+t.length)})};if(!c&&t.length>m)return void r("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!REGEX_VALID_SENTENCE_START.test(t))return void r(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp(REGEX_STR_VALID_SENTENCE_END).test(t))return void r(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);o+=t.length+(n<e-1?1:0)}t==e?i.find(".collapse").collapse("toggle"):(l={sentenceId:Number(i[0].dataset.sid),passageId:g,eng:t,sameText:!1,orderNum:Number(i[0].dataset.ordernum)},h.length+=t.length,l.sameTextSeq=e.toLowerCase()===t.toLowerCase(),$("#loadingModal").modal("show"),editPassageSentece(l,function(s){$("#loadingModal").modal("hide");let l=s.length;if(1<l){let o=`문장이 아래와 같이 ${l}개로 나뉘었습니다.`;i.find(".edit-section").one("hidden.bs.collapse",function(){i.hide(()=>{let t=new Array(l);for(let e=0;e<l;e++){var n=s[e],a=i.clone();a.find(".sentence-text, textarea").text(n.eng),a[0].dataset.sid=n.sentenceId,a[0].dataset.ordernum=n.orderNum,i.before(a),o+=`
[${e+1}] `+n.eng,t[e]=a[0]}i.remove(),$(u).slideDown(),p(),x(),alertModal(o,()=>{f(()=>b(t))})})}).collapse("hide")}else if(1===l){let e=s[0],t=i.find(".edit-section");alertModal("수정되었습니다.",()=>{f(()=>{i.find(".sentence-text").text(e.eng),i[0].dataset.sid=e.sentenceId,t.find("textarea").val(e.eng).end().collapse("hide"),b(i[0])})})}},function(){alertModal("수정에 실패했습니다."),$("#loadingModal").modal("hide")}))}}}).on("click",".js-del-sentence",function(){if(confirm("문장을 삭제하시겠습니까?")){let e=$(this.closest(u));delPassageSentence({passageId:g,sentenceId:Number(e[0].dataset.sid)},function(){alertModal("문장이 삭제되었습니다."),e.slideUp(function(){$(this).remove(),p(),x()})})}})}