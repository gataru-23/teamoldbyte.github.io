function pageinit(r,t,a){$(window).on("unload",()=>$("#loadingModal").modal("hide"));let x={itemSelector:".passage",columnWidth:".passage",gutter:10,percentPosition:!0,transitionDuration:"0.8s"},n=1e4.toLocaleString();var e=(new Date).format("yyyy-MM-dd");let d="MFUSG";var s=localStorage.getItem(d);let c=s?JSON.parse(atob(s)):{};s=[$.getJSON("https://static.findsvoc.com/data/member/unlockedLimitMembers.json?time="+Date.now().toString())];c.user==ntoa(t)&&c.date==e||(c={user:ntoa(t),date:e,length:0},s.push($.getJSON("/workbook/passage/usage").done(e=>Object.assign(c,{length:e})))),Promise.allSettled(s).then(([{value:e}])=>{!a&&!e.includes(t)&&1e4<=c.length&&($("#inputComplete, .ocr-btn").prop("disabled",!0),$("#newPassageText").prop("disabled",!0).addClass("form-control").attr("placeholder",`일일 분석량(${n}자)을 모두 소진했습니다. 내일 다시 찾아와 주세요.`),alertModal(`일일 분석량<span class="text-red-700">(${n}자)</span>을 모두 <span class="text-red-700">소진</span>했습니다.
내일 다시 찾아와 주세요.`)),localStorage.setItem(d,btoa(JSON.stringify(c)))}),$("[class^=step-] .title-section").on("click",function(){$("[class^=step-] .collapse").not($(this).closest("[class^=step-]").find(".collapse").collapse("show")).collapse("hide")}),r&&(sessionStorage.setItem("workbookCover","https://static.findsvoc.com/images/app/workbook/bookcover/hellobook_cover.jpeg"),new bootstrap.Tooltip(document.querySelector(".ocr-btn"),{trigger:"hover focus"}).enable());let i="",o=!1,l={};e=$("#newPassageText").autocomplete({position:{my:"left+10 top-10"},delay:500,search:function(){return 4<this.value.sentenceNormalize().length},source:(e,t)=>{(i=tokenizer.sentences(e.term.sentenceNormalize())[0])in l?t(l[i]):$.getJSON("/sentence/search",{eng:i},e=>{o=0<e.length;e=Array.from(e,e=>e.eng);l[i]=e,t(e)}).fail(()=>{o=!1,l[i]=[],t([])})},focus:()=>!1,close:function(){var e=this.value.trim().length;$(".demo-counter").text(e+"/"+p),$(".reset-textarea").toggle(0<e)},change:function(e,t){r&&null!=t.item&&(this.value=t.item.value,t=t.item.value.length,$(".demo-counter").text(t+"/"+p),$(".reset-textarea").toggle(0<t))},select:function(e,t){if(!r)return confirmModal("선택한 문장으로 지문을 검색하시겠습니까?",()=>{t.item.value.length>this.value.trim().length&&(this.value=t.item.value),$("#searchBtn").trigger("click",t.item.value)}),!1}}).autocomplete("instance");e._renderItem=function(e,t){var a=$("<li>");return t.disabled&&a.addClass("ui-state-disabled"),a.append(("<div>"+t.label+"</div>").replace(i,'<span class="bg-fc-yellow">$&</span>')),a.appendTo(e)},e._resizeMenu=function(){this.menu.element.outerWidth($("#newPassageText").innerWidth())};let p=r?300:2e3,g,u;if($(".demo-counter").text("0/"+p),$(document).on("input","#newPassageText",function(){var e=(()=>{let e=$("#newPassageText").val(),t=$("#newPassageText")[0].selectionStart,a=extractHighlightInfo(e,t);return $("#newPassageText").val(a.input),$("#newPassageText").highlightWithinTextarea({highlight:[{className:"bg-fc-yellow",highlight:["×"]},{className:"bg-fc-purple corrected",highlight:a.arr}]}),$("#newPassageText").trigger("focus")[0].setSelectionRange(a.inputCursor,a.inputCursor),[a.input.includes("×"),0<a.arr.length]})(),t=this.value.trim().quoteNormalize().length;$(".demo-counter").text(t+"/"+p),$(".reset-textarea").toggle(0<t),$(".invalid-input-warning").toggle(e[0]),$(".corrected-input-info").toggle(e[1]),null==u||u.paused||u.remove(".hwt-backdrop mark.corrected"),u=anime({targets:".hwt-backdrop mark.corrected",keyframes:[{opacity:0,easing:"linear",duration:500},{opacity:1,easing:"linear",duration:500}],loop:!0}),a||t<p&&!e[0]?($("#inputComplete").attr("disabled",0==t),g?.hide(),g?.disable(),$(this).trigger("keydown")):((g=g||new bootstrap.Tooltip(this,{title:`영어 문장을 ${p}자 이내로 입력하세요.`,trigger:"manual",customClass:"text-invalid",offset:({placement:e})=>"top"==e?[100,0]:[0,0]})).enable(),g.show(),$("#inputComplete").attr("disabled",!0))}),!r){let t=new FicoOCR;$("#ocrFile").on("input",function(){var e=this.files[0];if(null==e||0==e.size)return alertModal("선택된 사진이 없습니다.\n앨범에서 사진을 선택해 주세요."),!1;t.readAsPreview(e,e=>{var t=document.getElementById("newPassageText");t.value=e,t.scrollTop=0,t.setSelectionRange(0,0),t.focus(),$(t).trigger("input")},()=>alertModal("이미지 인식에 실패했습니다. 입력창에 문장 수동 입력을 해주세요.")),this.value=""}),33<=JSON.parse(sessionStorage.getItem("passageIdList"))?.length&&(alertModal("워크북의 지문 수가 최대 33개에 도달했습니다.\n새 워크북 등록 화면으로 이동합니다."),location.assign("/workbook/mybook/add"))}$("#inputComplete").on("click",async function(){var e=document.getElementById("newPassageText"),e=tokenizer.sentences(e.value.sentenceNormalize());r||1!=e.length?!a&&r&&e.reduce((e,t)=>e+t.length,0)>p?alertModal(p+`자가 넘는 문장은
워크북에서 등록하실 수 있습니다.`):$("#beforeSubmitModal").modal("show"):(0==$("#askMoreSentenceModal").length&&document.body.appendChild(createElement({el:"div",id:"askMoreSentenceModal",class:"warning-modal modal fade",children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-header text-center bg-fc-purple mx-auto w-100",children:[{el:"span",className:"text-white d-block w-100",children:["여러 문장을 등록하여 ",{el:"b",class:"text-fc-yellow",textContent:"지문을 관리"},"해 보세요."]}]},{el:"div",class:"modal-body row g-0",children:[{el:"div",class:"logo-section col-6 col-md-3 m-auto pe-md-2 text-center",children:[{el:"img",class:"logo",alt:"logo",src:"https://static.findsvoc.com/images/logo/main_logo_character_anim.svg"}]},{el:"div",class:"text-section my-auto pt-2 pt-md-0 ps-md-2 col-md-9",children:[{el:"p",className:"mb-2",children:["워크북은 사용자에게 학습 응집성을 제공하기 위해 문장을 ",{el:"b",class:"text-fc-red",textContent:"지문단위로 관리"},"합니다."]},{el:"p",className:"mb-2",children:["학습목적이나 주제에 맞는 문장들을 미리 준비하여 ",{el:"b",class:"text-fc-red",textContent:"한번에 등록"},"하는 것을 추천드립니다."]},{el:"p",className:"mb-2",children:["워크북을 자신의 ",{el:"b",class:"text-fc-red",textContent:"학습 자산"},"으로 만들어 보세요."]},{el:"p",className:"mb-4",children:[{el:"span",class:"app-name-text",textContent:"fico"},"가 그 가치를 성장시켜 드리겠습니다."]},{el:"span",className:"text-sm text-bluegray-400",textContent:"관리가 불필요한 한 두문장 등록은 헬로북에서도 가능합니다."}]}]},{el:"div",className:"modal-footer py-0",children:[{el:"div",className:"text-center w-100",children:[{el:"button",type:"button",className:"btn btn-fico me-0 w-50","data-bs-dismiss":"modal",textContent:"예(문장 추가 입력)"},{el:"button",type:"button",id:"goOnSearch",className:"btn btn-outline-fico w-50","data-bs-dismiss":"modal",textContent:"아니오(그대로 분석)",onclick:()=>$("#beforeSubmitModal").modal("show")}]}]}]}]}]})),$("#askMoreSentenceModal").modal("show"))}),$(document).on("input",".divided-sentence :text",function(){var e=this.value.trim().quoteNormalize();1!=REGEX_VALID_SENTENCE_START.test(e)?($(this).siblings(".invalid-tooltip").text("문장의 시작은 영문대문자, 숫자 혹은 따옴표(\" ')여야 합니다."),$(this).addClass("is-invalid")):new RegExp(REGEX_STR_VALID_SENTENCE_END).test(e)?$(this).removeClass("is-invalid"):($(this).siblings(".invalid-tooltip").text("문장의 끝은 구두점(. ? !) 혹은 따옴표(\" ')여야 합니다."),$(this).addClass("is-invalid"))}).on("click",".js-delete-sentence-btn",function(){$(".edit-passage .divided-sentence").length<2?alertModal("최소 한 문장은 필요합니다. 처음부터 입력하고 싶으시다면 '입력 초기화'를 눌러 주세요"):confirmModal("삭제하시겠습니까?",()=>{$(this).closest(".divided-sentence").fadeOut(function(){var e=$(this).siblings(".divided-sentence").last();$(this).remove(),e.find(":text").trigger("input")})})}).on("click",".js-insert-sentence-btn",async function(){var e=$("#hiddenDivs .divided-sentence").clone();$(this).closest(".divided-sentence").after(e),await sleep(50),e.fadeIn().find(":text").trigger("input")}),$("#searchBtn").on("click",async function(e,t){null==u||u.paused||u.remove(".hwt-backdrop mark.corrected"),$(".hwt-backdrop mark.corrected").remove(),$(".corrected-input-info").hide();let s=document.getElementById("newPassageText");var a=tokenizer.sentences(s.value.sentenceNormalize());if(r)if(a.reduce((e,t)=>e+t.length,0)>p)alertModal(p+`자가 넘는 문장은
워크북에서 등록하실 수 있습니다.`);else{var n=$("#dividedResult").empty();for(let e=0,t=a.length;e<t;e++){var i=$("#hiddenDivs .divided-sentence").clone();i.appendTo(n),await sleep(50),i.fadeIn().find(":text").val(a[e]).trigger("input")}$("#beforeInput").addClass("opacity-50 pe-none"),$(".before-msg").hide(),$("#afterInput").removeClass("d-none opacity-50 pe-none")}else{let f=wrapQuotes(a.filter(e=>/[a-zA-Z\s]/.test(e))),e=f[0];if(s.value=f.join(" "),null!=t)e=t;else{let n=0;for(let a=0,e=f.length;a<e;a++){let t=f[a];var o=e=>{alertModal(a+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+t,()=>{s.focus(),s.setSelectionRange(n,n+t.length)})};if(500<t.length)return void o("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!REGEX_VALID_SENTENCE_START.test(t))return void o(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp(REGEX_STR_VALID_SENTENCE_END).test(t))return void o(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);n+=t.length+(a<e-1?1:0)}}$(".search-sentence").text(e);let v=-1,b;$.getJSON("/workbook/passage/search",{eng:e},function(e){let a=e.passageDtoList,n=e.sentenceDtoList,s=$(".passage-result").empty();s.data("masonry")&&s.masonry("destroy");v=a.findIndex(e=>e.text==f.join(" "));for(let e=0,t=a.length;e<t;e++){var i=a[e];if(!(-1<v&&e!=v)||i.text.length>f.join(" ").length&&i.text.includes(f.join(" "))){var o=$("#hiddenDivs .list-group-item").clone(),l=tokenizer.sentences(i.text),r=Array.from(f),d=Array.from(l);let t="<span ";var c=[];let a=0;for(;0<d.length;){let t=d.shift();var p=r.indexOf(t);-1<p?(c.push({text:t,inputPosition:p,outputPosition:a,matchType:"same"}),r[p]=null):(p=f.findIndex(e=>.8<sentenceSimilarity(e,t)),c.push(-1<p?{text:t,inputPosition:p,outputPosition:a,matchType:"similar"}:{text:t,inputPosition:-1,outputPosition:a,matchType:"outputonly"})),a++}var g=c.filter(e=>-1<e.inputPosition&&["same","similar"].includes(e.matchType));if(g.sort((e,t)=>e.inputPosition-t.inputPosition),1<g.length)for(a=1;a<g.length;a++)"similar"!=g[a].matchType&&g[a].outputPosition<g[a-1].outputPosition&&(c[g[a].outputPosition].matchType="disorder",c[g[a-1].outputPosition].matchType="disorder");for(a=0;a<f.length;a++){var u=f[a];0==g.length?c.push({text:u,inputPosition:a,outputPosition:-1,matchType:"inputonly"}):a<g[0].inputPosition?c.splice(g[0].outputPosition,0,{text:u,inputPosition:a,outputPosition:-1,matchType:"inputonly"}):a==g[0].inputPosition&&g.shift()}for(a=0;a<c.length;a++){var m=c[a];let e="";switch(m.matchType){case"same":e+='class="exact-match" data-bs-toggle="tooltip" data-bs-title="정확히 일치하는 문장"';break;case"similar":e+='class="similar-sentence" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="유사한 내용의 문장: '+f[m.inputPosition].replaceAll('"',"&quot;")+'"';break;case"disorder":e+='class="different-order" data-bs-toggle="tooltip" data-bs-title="다른 문장과 순서가 바뀐 문장"';break;case"outputonly":e+='class="additional-sentence" data-bs-toggle="tooltip" data-bs-title="입력에는 없었지만, 검색 결과에서 새롭게 포함된 문장이 있습니다. 어떤 문장이 추가되었는지 확인해주세요."';break;case"inputonly":e+='class="missing-sentence" data-bs-toggle="tooltip" data-bs-title="입력에는 포함되었으나, 검색 결과에서는 확인되지 않은 문장이 있습니다. 누락된 문장이 무엇인지 확인해주세요."'}0<a?c[a-1].matchType!=m.matchType||"similar"==m.matchType?t+="</span> <span "+e+">":t+=" ":t+=e+">",t+=m.text}t+="</span>",o.data("passageId",i.passageId).html(t),s.append(o),e==v&&(b=o.addClass("same-content"))}}if(1==f.length)for(let e=0,t=n.length;e<t;e++){var h=$("#hiddenDivs .list-group-item").clone();h.data("sentenceId",n[e].sentenceId).html(n[e].eng.replace(f,`<span class="exact-match" data-bs-toggle="tooltip" data-bs-title="정확히 일치하는 문장">${f}</span>`)),s.append(h)}1<f.length&&0==a.length||1==f.length&&0==n.length?s.append('<li class="list-group-item pe-none no-passage">검색 결과가 없습니다.</li>'):s.append($("#jumpTo3").clone(!0,!0));$(".step-2").removeClass("opacity-50 pe-none"),$(".step-2 .collapse").one("shown.bs.collapse",function(){1<f.length&&0==a.length||1==f.length&&0==n.length?$("#jumpTo3").trigger("click"):(s.masonry(x),-1<v&&1==s.find(".list-group-item").length&&(s.find("#jumpTo3").addClass("btn disabled"),b?.trigger("click")))}),$(".step-1 .collapse, .step-2 .collapse").collapse("toggle")}).fail(()=>alertModal("검색을 할 수 없습니다. 페이지 새로고침 후 다시 시도해 주세요."))}}),$("#passageForm").on("reset",function(){$("#inputComplete").prop("disabled",!0),r?($("#dividedResult").empty(),$("#afterInput").addClass("opacity-50 pe-none"),$("#beforeInput").removeClass("opacity-50 pe-none")):($(".step-2 .collapse,.step-3 .collapse").collapse("hide"),$(".step-1 .collapse").collapse("show"),$(".step-1").removeClass("opacity-50 pe-none"),$(".step-2, .step-3").addClass("opacity-50 pe-none")),$("#newPassageText").val("").prop("disabled",!1).trigger("input").trigger("focus")});let m;async function h(a){$(".final-passage").hide();var n=$(".edit-passage").show().find(".sentence-list").empty();for(let e=0,t=a.length;e<t;e++){var s=$("#hiddenDivs .divided-sentence").clone();s.appendTo(n),await sleep(50),s.data("sentenceId",a[e].sentenceId||0).data("orgData",a[e].eng).fadeIn().find(":text").val(a[e].eng).trigger("input")}}r||($("#jumpTo3").on("click",function(){$("#text").val($("#newPassageText").val()),$(".search-result-section .list-group-item").removeClass("active"),$(".step-2,.step-3").removeClass("opacity-50 pe-none"),$(".step-2 .collapse,.step-3 .collapse").collapse("toggle"),h(Array.from(tokenizer.sentences($("#newPassageText").val().trim()).filter(e=>/[a-zA-Z]/.test(e)),e=>({eng:e.sentenceNormalize()}))).then(()=>{let n=new Set,s=$();$(".step-3 .divided-sentence").each((e,t)=>{var a=$(t).find(":text").val();n.has(a)?s=s.add($(t)):n.add(a)}),0<s.length&&(s.find("input:text").addClass("bg-warning"),alertModal("중복된 문장 "+Array.from(s,e=>$(e).index()+1).toString()+"번째 문장은 제거됩니다.",()=>{s.remove()}))})}),$(".step-2 .collapse:eq(0)").on("shown.bs.collapse hidden.bs.collapse",function(){$("#jumpTo3").fadeToggle()}),$(document).on("click",".search-result-section .list-group-item",function(){$(".search-result-section .list-group-item").not(this).removeClass("active"),$(this).addClass("active"),$("#text").val($(this).text()),$(".step-2,.step-3").removeClass("opacity-50 pe-none"),$(".step-2 .collapse,.step-3 .collapse").collapse("toggle");var e,t=$(this);t.data("passageId")?(e=t.data("passageId"),$.getJSON("/workbook/passage/sentences/edit/"+e,h).fail(()=>alertModal("지문을 편집할 수 없습니다."))):t.data("sentenceId")&&(e=t.data("sentenceId"),h([{eng:t.text(),sentenceId:e}]))}),$(".step-3 .collapse:eq(0)").on("shown.bs.collapse",async function(){o=!1,$("#addBtn").prop("disabled",!1)}),$("#cancelEdit").on("click",function(){$(".final-passage, .edit-passage").toggle()}),null!=(m=localStorage.getItem("PassageTagHistory"))?(m=JSON.parse(decodeURI(m)),$("#taghistory").get(0).appendChild(createElement(Array.from(m,e=>({el:"option",textContent:e}))))):m=[]),$("#addBtn").on("click",async function(){let n=$("#passageForm"),a=0;if(r){var s=$("#dividedResult :text");let t=[];if(s.each(function(){var e=this.value.trim().sentenceNormalize();t.push(e),a+=e.length}),t.reduce((e,t)=>e+t.length,0)>p)return void alertModal(p+`자가 넘는 문장은
워크북에서 등록하실 수 있습니다.`);createHidden(n,"text",t.join("\n"))}else{n[0].action="/workbook/passage/add",0==$("#title").val().length&&$("#title").removeAttr("name");let t=!1;s=$(".search-result-section .list-group-item.active");if(0<s.length){var i=s.data("passageId"),o=s.data("sentenceId"),l=$(".edit-passage .divided-sentence");let e=[];l.each(function(){e.push($(this).find(":text").val().trim())}),s.text()!=e.join(" ")?(l.each(function(e,t){var a=$(t).find(":text").val().trim().sentenceNormalize();$(this).data("orgData")!=a?createHidden(n,`existingSentenceList[${e}].eng`,a):createHidden(n,`existingSentenceList[${e}].sentenceId`,$(t).data("sentenceId"))}),n.find("#text").prop("disabled",!0),t=!0):(n.find("#text").prop("disabled",!0),null!=i?createHidden(n,"existingPassageId",i):(t=!0,createHidden(n,"existingSentenceList[0].sentenceId",o))),a+=e.join(" ").length}else{s=$(".edit-passage .divided-sentence"),l=Array.from(s.get(),e=>$(e).find(":text").val().trim().sentenceNormalize());0<$(".search-result-section .list-group-item:not(.no-passage)").length?(t=!0,l.forEach((e,t)=>{createHidden(n,`existingSentenceList[${t}].eng`,e)}),n.find("#text").prop("disabled",!0)):(n[0].action="/workbook/passage/new",n.find("#text").prop("disabled",!1).val(l.join(" "))),a+=l.join(" ").length}createHidden(n,"dirty",t);i=$("#tag").val().trim();0<i.length&&!m.includes(i)&&(m.push(i),localStorage.setItem("PassageTagHistory",encodeURI(JSON.stringify(m))))}c.length+=a,localStorage.setItem(d,btoa(JSON.stringify(c))),n.trigger("submit")}),$("#passageForm").on("submit",function(){!a&&r&&$(this).find('input[name="text"]').text().length>p?alertModal(p+`자가 넘는 문장은
워크북에서 등록하실 수 있습니다.`):($("#addBtn").prop("disabled",!0),$("#loadingModal").modal("show"))})}